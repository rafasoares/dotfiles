export LANG=en_US.UTF-8
export LC_ALL=en_US.UTF-8

{{ if eq .chezmoi.os "darwin" -}}
eval $(brew shellenv)
export HOMEBREW_NO_ENV_HINTS=1
{{- end }}

ZINIT_HOME={{ joinPath .chezmoi.homeDir ".local/share/zinit" }}
source "${ZINIT_HOME}/zinit.zsh"

if [ "$TERM_PROGRAM" != "Apple_Terminal" ]; then
  eval "$(oh-my-posh init zsh --config "$(brew --prefix oh-my-posh)/themes/hotstick.minimal.omp.json")"
fi

# Load custom zsh configuration
for file in $HOME/.config/zsh/*.zsh; do source "$file"; done

# Load oh-my-zsh plugins
zi ice as'completion'; zi snippet OMZP::docker/completions/_docker

zinit snippet OMZP::aliases
zinit snippet OMZP::bundler
zinit snippet OMZP::common-aliases
zinit snippet OMZP::colored-man-pages
zinit snippet OMZP::docker-compose
zinit snippet OMZP::git
zinit snippet OMZP::rails

# Load zinit plugins
zinit light zdharma-continuum/fast-syntax-highlighting
zinit light zsh-users/zsh-completions
zinit light zsh-users/zsh-autosuggestions
zinit light Aloxaf/fzf-tab
zinit light ntnyq/omz-plugin-pnpm

{{- if eq .chezmoi.os "darwin" }}
zinit snippet OMZP::brew
{{- end }}

# Load completions
remove_conflicting_git_completions
fpath=($(brew --prefix)/share/zsh/site-functions $fpath)
zicompinit

# Bind history search to up and down arrow keys
bindkey '^[[A' history-search-backward
bindkey '^[[B' history-search-forward

# Configure history
HISTFILE=$HOME/.config/zsh/.zsh_history
HISTSIZE=10000
SAVEHIST=$HISTSIZE
HISTDUP=erase
setopt appendhistory
setopt sharehistory
setopt hist_ignore_dups
setopt hist_ignore_all_dups
setopt hist_save_no_dups
setopt hist_find_no_dups
setopt hist_ignore_space

# Configure corrections
unsetopt correct_all
setopt correct
unsetopt nomatch

# Configure completion
COMPLETION_WAITING_DOTS="true"


# Load external utilities
[ $(command -v chezmoi) ] && eval "$(chezmoi completion zsh)"
[ "$(command -v fzf)" ] && eval "$(fzf --zsh)"
[ "$(command -v zoxide)" ] && eval "$(zoxide init --cmd cd zsh)"
[ "$(command -v fnm)" ] && eval "$(fnm env --use-on-cd)"
[ "$(command -v scloud)" ] && eval "$(scloud --shell zsh)"

# Set the editor
if [ "$(command -v code)" ]; then
  export EDITOR="code -w"
elif [ "$(command -v nvim)" ]; then
  export EDITOR="nvim"
else
  export EDITOR="vim"
fi

{{ if eq .chezmoi.os "linux" }}
# Configure Homebrew on Linux, if available
if [ -d /home/linuxbrew/.linuxbrew ]; then
  eval $(/home/linuxbrew/.linuxbrew/bin/brew shellenv)
fi
{{ end }}

# replay completions
zicdreplay
